<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Copilot: Production-optimized version for GitHub Pages deployment -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotus Payday Lending Simulation</title>
    
    <!-- Critical CSS (inlined for performance) -->
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;color:#333}
        .loader{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
        .loader::after{content:'';width:50px;height:50px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .hidden{display:none!important}
        .app{opacity:0;transition:opacity .5s}
        .app.loaded{opacity:1}
        .header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
        .nav{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;max-width:1200px;margin:0 auto}
        .logo{font-size:1.5rem;font-weight:700;color:#667eea}
        .mode-switch{display:flex;gap:10px}
        .mode-btn{padding:8px 16px;border:2px solid #667eea;background:transparent;color:#667eea;border-radius:20px;cursor:pointer;transition:all .3s}
        .mode-btn.active{background:#667eea;color:#fff}
        .hero{min-height:90vh;display:flex;align-items:center;justify-content:center;text-align:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
        .hero-content h1{font-size:3rem;margin-bottom:1rem}
        .hero-content p{font-size:1.2rem;margin-bottom:2rem;opacity:.9}
        .cta{padding:15px 30px;background:#fff;color:#667eea;border:none;border-radius:30px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:transform .3s}
        .cta:hover{transform:translateY(-2px)}
        .container{max-width:1200px;margin:0 auto;padding:2rem}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem}
        .card{background:#fff;border-radius:10px;padding:2rem;box-shadow:0 5px 15px rgba(0,0,0,.1);transition:transform .3s}
        .card:hover{transform:translateY(-5px)}
        @media(max-width:768px){.nav{padding:1rem}.hero-content h1{font-size:2rem}.container{padding:1rem}}
    </style>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="app_optimized.js" as="script">
    <link rel="preload" href="assets/global.css" as="style">
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    
    <!-- SEO and social media -->
    <meta name="description" content="Interactive simulation comparing predatory vs ethical payday lending practices. Educational tool for financial literacy.">
    <meta property="og:title" content="Lotus Payday Lending Simulation">
    <meta property="og:description" content="Learn about predatory lending through interactive simulation">
    <meta property="og:type" content="website">
    
    <!-- PWA support -->
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™∑</text></svg>">
</head>
<body>
    <!-- Loading screen -->
    <div id="loader" class="loader" aria-label="Loading application"></div>
    
    <!-- Main application -->
    <div id="app" class="app hidden">
        <!-- Header -->
        <header class="header">
            <nav class="nav">
                <div class="logo">ü™∑ Lotus</div>
                <div class="mode-switch">
                    <button class="mode-btn active" data-mode="compare">Compare</button>
                    <button class="mode-btn" data-mode="predatory">Predatory</button>
                    <button class="mode-btn" data-mode="ethical">Ethical</button>
                </div>
            </nav>
        </header>
        
        <!-- Hero section -->
        <section class="hero">
            <div class="hero-content">
                <h1>Understanding Payday Lending</h1>
                <p>Experience the difference between predatory practices and ethical alternatives</p>
                <button class="cta" onclick="startSimulation()">Start Simulation</button>
            </div>
        </section>
        
        <!-- Main content -->
        <main id="main-content" class="container">
            <!-- Default comparison view -->
            <div id="compare-view">
                <h2 style="text-align:center;margin-bottom:2rem">Compare Lending Approaches</h2>
                <div class="grid">
                    <div class="card">
                        <h3 style="color:#dc3545;margin-bottom:1rem">‚ùå Predatory Lending</h3>
                        <ul style="margin-bottom:2rem">
                            <li>Hidden fees and terms</li>
                            <li>Aggressive marketing</li>
                            <li>Debt trap mechanisms</li>
                            <li>Average APR: 400%+</li>
                        </ul>
                        <button class="mode-btn" onclick="switchMode('predatory')">Experience This</button>
                    </div>
                    <div class="card">
                        <h3 style="color:#28a745;margin-bottom:1rem">‚úÖ Ethical Alternative</h3>
                        <ul style="margin-bottom:2rem">
                            <li>Full transparency</li>
                            <li>Educational resources</li>
                            <li>Alternative options</li>
                            <li>Fair terms</li>
                        </ul>
                        <button class="mode-btn" onclick="switchMode('ethical')">Explore This</button>
                    </div>
                </div>
            </div>
            
            <!-- Dynamic content area -->
            <div id="dynamic-content"></div>
        </main>
        
        <!-- Footer -->
        <footer style="background:#f8f9fa;padding:2rem;text-align:center;border-top:1px solid #e9ecef">
            <p style="margin-bottom:1rem">Educational simulation - Not actual lending services</p>
            <div style="display:flex;justify-content:center;gap:2rem;flex-wrap:wrap">
                <a href="#" onclick="showResources()">Consumer Resources</a>
                <a href="#" onclick="showRegulations()">Regulations</a>
                <a href="#" onclick="showHelp()">Get Help</a>
            </div>
        </footer>
    </div>
    
    <!-- Optimized JavaScript -->
    <script>
        (function() {
            'use strict';
            
            // Performance tracking
            const perf = { start: performance.now(), marks: {} };
            const mark = name => perf.marks[name] = performance.now() - perf.start;
            
            // Application state
            const state = {
                mode: 'compare',
                loaded: false,
                components: new Map()
            };
            
            // Optimized DOM utilities
            const $ = id => document.getElementById(id);
            const $$ = sel => document.querySelectorAll(sel);
            
            // Module loader with caching
            const loadModule = (() => {
                const cache = new Map();
                return async (path) => {
                    if (cache.has(path)) return cache.get(path);
                    try {
                        const response = await fetch(path);
                        const content = await response.text();
                        cache.set(path, content);
                        return content;
                    } catch (error) {
                        console.warn(`Failed to load ${path}:`, error);
                        return null;
                    }
                };
            })();
            
            // Component loader
            const loadComponent = async (type, target = 'dynamic-content') => {
                const targetEl = $(target);
                if (!targetEl) return;
                
                let content = '';
                
                switch (type) {
                    case 'predatory-form':
                        content = await loadModule('predatory/form.html');
                        break;
                    case 'predatory-hero':
                        content = await loadModule('predatory/hero.html');
                        break;
                    case 'ethical-calculator':
                        content = await loadModule('partials/ethical/calculator.html');
                        break;
                    case 'ethical-alternatives':
                        content = await loadModule('partials/ethical/alternatives.html');
                        break;
                }
                
                if (content) {
                    targetEl.innerHTML = content;
                    // Execute any scripts in the loaded content
                    targetEl.querySelectorAll('script').forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.head.appendChild(newScript);
                        document.head.removeChild(newScript);
                    });
                }
            };
            
            // Mode switching
            window.switchMode = async (mode) => {
                if (mode === state.mode) return;
                
                mark(`switch_to_${mode}`);
                state.mode = mode;
                
                // Update UI
                $$('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                // Update content
                const compareView = $('compare-view');
                const dynamicContent = $('dynamic-content');
                
                if (mode === 'compare') {
                    compareView.style.display = 'block';
                    dynamicContent.innerHTML = '';
                } else {
                    compareView.style.display = 'none';
                    await loadModeContent(mode);
                }
                
                // Update URL without reload
                const url = new URL(location);
                url.searchParams.set('mode', mode);
                history.pushState({ mode }, '', url);
                
                // Track mode switch
                if (navigator.serviceWorker?.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'TRACK_INTERACTION',
                        data: { type: 'mode_switch', mode, timestamp: Date.now() }
                    });
                }
            };
            
            // Load mode-specific content
            const loadModeContent = async (mode) => {
                const container = $('dynamic-content');
                
                switch (mode) {
                    case 'predatory':
                        container.innerHTML = `
                            <div class="predatory-mode">
                                <div style="background:#dc3545;color:white;padding:1rem;text-align:center;margin-bottom:2rem">
                                    ‚ö†Ô∏è PREDATORY LENDING SIMULATION ‚ö†Ô∏è
                                </div>
                                <div id="predatory-hero"></div>
                                <div id="predatory-form"></div>
                            </div>
                        `;
                        await loadComponent('predatory-hero', 'predatory-hero');
                        await loadComponent('predatory-form', 'predatory-form');
                        break;
                        
                    case 'ethical':
                        container.innerHTML = `
                            <div class="ethical-mode">
                                <div style="background:#28a745;color:white;padding:1rem;text-align:center;margin-bottom:2rem">
                                    ‚úÖ ETHICAL LENDING ALTERNATIVE
                                </div>
                                <div id="ethical-calculator"></div>
                                <div id="ethical-alternatives"></div>
                            </div>
                        `;
                        await loadComponent('ethical-calculator', 'ethical-calculator');
                        await loadComponent('ethical-alternatives', 'ethical-alternatives');
                        break;
                }
            };
            
            // Global functions
            window.startSimulation = () => {
                document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
            };
            
            window.showResources = () => {
                window.open('https://www.consumerfinance.gov/consumer-tools/payday-loans/', '_blank');
            };
            
            window.showRegulations = () => {
                alert('State-specific regulations would be shown here');
            };
            
            window.showHelp = () => {
                window.open('https://www.nfcc.org/', '_blank');
            };
            
            // Event delegation for performance
            document.addEventListener('click', (e) => {
                if (e.target.matches('.mode-btn[data-mode]')) {
                    switchMode(e.target.dataset.mode);
                }
            });
            
            // Initialize application
            const init = async () => {
                mark('init_start');
                
                // Check URL for initial mode
                const urlParams = new URLSearchParams(location.search);
                const initialMode = urlParams.get('mode') || 'compare';
                
                // Load critical CSS
                const css = document.createElement('link');
                css.rel = 'stylesheet';
                css.href = 'assets/global.css';
                document.head.appendChild(css);
                
                // Initialize mode
                await switchMode(initialMode);
                
                // Show app, hide loader
                mark('init_complete');
                $('loader').classList.add('hidden');
                $('app').classList.remove('hidden');
                $('app').classList.add('loaded');
                
                state.loaded = true;
                
                console.log('‚úÖ Lotus optimized version loaded in', perf.marks.init_complete.toFixed(2) + 'ms');
            };
            
            // Service Worker registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => mark('sw_registered'))
                    .catch(err => console.warn('SW registration failed:', err));
            }
            
            // Start when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
            // Expose for debugging
            window.LotusOptimized = { state, perf, switchMode, loadComponent };
            
        })();
    </script>
    
    <!-- Load additional scripts after initial render -->
    <script>
        // Lazy load non-critical scripts
        setTimeout(() => {
            const scripts = ['app_optimized.js'];
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.defer = true;
                document.head.appendChild(script);
            });
        }, 1000);
    </script>
</body>
</html>