<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Copilot: Master Index - Full 73-file scaffold integration with dual-mode functionality -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lotus Payday Loan Simulator - Educational Dual Mode</title>
  
  <!-- Global Assets -->
  <link rel="stylesheet" href="assets/global.css">
  
  <!-- Mode-specific stylesheets (switched via JavaScript) -->
  <link rel="stylesheet" href="predatory/styles.css" id="pred-styles">
  <link rel="stylesheet" href="ethical/styles.css" id="eth-styles" disabled>
  
  <!-- PWA and SEO -->
  <meta name="description" content="Educational simulation comparing predatory vs ethical payday lending practices with autonomy theater integration">
  <meta name="theme-color" content="#667eea">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico">
  
  <!-- Tailwind CSS for simulation interface -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js for interactivity -->
  <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
  
  <!-- Critical CSS for interface switching -->
  <style>
    /* Copilot: Interface mode switching styles */
    .interface-selector {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 2000;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .mode-switch-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .interface-button, .mode-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 2px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .interface-button.active, .mode-button.active {
      background: #28a745;
      transform: scale(1.05);
    }
    
    .interface-button:hover, .mode-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* Interface containers */
    .simulation-interface {
      display: block;
    }
    
    .ui-interface {
      display: none;
    }
    
    .simulation-interface.hidden,
    .ui-interface.hidden {
      display: none !important;
    }
    
    /* Smooth transitions */
    .fade-transition {
      transition: opacity 0.5s ease-in-out;
    }
    
    .fade-out {
      opacity: 0;
    }
    
    .fade-in {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Interface Selection Controls -->
  <div class="interface-selector">
    <div style="font-weight: 600; margin-bottom: 8px; font-size: 11px; color: #666;">Interface:</div>
    <button class="interface-button active" id="sim-interface-btn" onclick="switchInterface('simulation')">
      Terminal Simulation
    </button>
    <button class="interface-button" id="ui-interface-btn" onclick="switchInterface('ui')">
      UI Experience
    </button>
  </div>

  <!-- Mode Selection Controls -->
  <div class="mode-switch-container">
    <div style="font-weight: 600; margin-bottom: 8px; font-size: 11px; color: #666;">Mode:</div>
    <button class="mode-button active" id="predatory-btn" onclick="switchMode('predatory')">
      Predatory
    </button>
    <button class="mode-button" id="ethical-btn" onclick="switchMode('ethical')">
      Ethical
    </button>
  </div>

  <!-- SIMULATION INTERFACE (Terminal-style) -->
  <div id="simulation-interface" class="simulation-interface fade-transition">
    <div class="bg-gray-900 text-gray-200 font-mono antialiased min-h-screen">
      <div id="container" class="max-w-5xl mx-auto p-4 md:p-8">
        <header role="banner" class="text-center mb-10">
          <h1 class="text-4xl font-bold text-purple-400">Lotus + Autonomy Theater</h1>
          <p class="text-gray-400 mt-2 text-lg">An Interactive Simulation of Choice, Consent, and Coercion</p>
        </header>

        <!-- Urgency Banner for Exploitative Mode -->
        <div id="urgency-banner" class="hidden bg-red-800 border-2 border-red-500 text-center p-3 rounded-lg mb-6 shadow-lg animate-pulse">
          <p class="text-lg font-bold text-yellow-300">
            ðŸ”¥ INSTANT APPROVAL! <span id="timer">05:00</span> LEFT TO LOCK IN YOUR SPECIAL RATE! ðŸ”¥
          </p>
        </div>

        <main role="main">
          <!-- Section for simulation controls -->
          <section id="controls" aria-labelledby="controls-heading" class="mb-8 p-6 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
            <h2 id="controls-heading" class="text-2xl font-semibold text-center text-purple-300 mb-6">Simulation Setup</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
              <div class="flex flex-col">
                <label for="state-input" class="mb-2 text-sm font-medium text-gray-400">State (e.g., CO, TX)</label>
                <input type="text" id="state-input" placeholder="State Abbr." class="bg-gray-700 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
              </div>
              <div class="flex flex-col">
                <label for="amount-input" class="mb-2 text-sm font-medium text-gray-400">Loan Amount ($)</label>
                <input type="number" id="amount-input" placeholder="e.g., 500" class="bg-gray-700 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
              </div>
              <div class="flex flex-col">
                <label for="term-input" class="mb-2 text-sm font-medium text-gray-400">Loan Term (days)</label>
                <input type="number" id="term-input" placeholder="e.g., 14" class="bg-gray-700 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
              </div>
              <div class="flex flex-col">
                <label for="scenario-select" class="mb-2 text-sm font-medium text-gray-400">Empathy Scenario</label>
                <select id="scenario-select" class="bg-gray-700 border border-gray-600 rounded-lg p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                  <option value="">-- Select a Scenario --</option>
                  <option value="singleparent">Single Parent, Car Repair</option>
                  <option value="tempworker">Gig Worker, Medical Bill</option>
                </select>
              </div>
            </div>
            <div class="mode-selection mt-8 text-center">
              <p class="mb-4 font-semibold text-lg">Choose a simulation mode:</p>
              <div class="flex justify-center gap-6 flex-wrap">
                <button id="start-regulated" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-400">
                  Ethical & Regulated Simulation
                </button>
                <button id="start-exploit" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-400">
                  Exploitative Simulation
                </button>
              </div>
            </div>
          </section>

          <!-- Container for the live simulation output and input -->
          <section id="simContainer" aria-labelledby="simulation-heading" class="mb-8">
            <h2 id="simulation-heading" class="sr-only">Simulation Output</h2>
            <pre id="output" class="bg-black p-6 rounded-t-lg min-h-[350px] max-h-[60vh] overflow-y-auto whitespace-pre-wrap break-words font-mono text-sm border-2 border-gray-700 border-b-0">Welcome! Please configure your simulation and select a mode to begin.</pre>
            <div id="input-area" style="display: none;" class="flex">
              <input type="text" id="user-input" placeholder="Enter your response here..." class="flex-grow bg-gray-800 border-2 border-gray-700 p-3 rounded-bl-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
              <button id="submit-input" class="bg-purple-600 hover:bg-purple-500 text-white font-bold p-3 rounded-br-lg transition">Submit</button>
            </div>
          </section>

          <!-- Hidden pane for end-of-session reflection -->
          <section id="reflectionPane" x-data="{ tab: 'behavior' }" aria-labelledby="reflection-heading" class="hidden mt-10 p-6 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
            <h2 id="reflection-heading" class="text-2xl font-semibold text-center text-purple-300 mb-6">Ethical Reflection & Analysis</h2>

            <!-- Tab Navigation -->
            <div class="border-b border-gray-600">
              <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
                <button @click="tab = 'behavior'" :class="{ 'border-purple-400 text-purple-300': tab === 'behavior', 'border-transparent text-gray-500 hover:text-gray-300 hover:border-gray-400': tab !== 'behavior' }" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base focus:outline-none transition-colors">
                  Behavioral Analysis
                </button>
                <button @click="tab = 'ethics'" :class="{ 'border-purple-400 text-purple-300': tab === 'ethics', 'border-transparent text-gray-500 hover:text-gray-300 hover:border-gray-400': tab !== 'ethics' }" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-base focus:outline-none transition-colors">
                  Ethical Report
                </button>
              </nav>
            </div>

            <div id="reflection-content" class="mt-6 space-y-6">
              <!-- Always visible: Consent Score -->
              <div class="p-4 bg-gray-700 rounded-lg">
                <h3 class="font-bold text-lg">Informed Consent Score:</h3>
                <div class="w-full bg-gray-600 rounded-full h-5 mt-2">
                  <div id="consent-bar" class="bg-green-500 h-5 rounded-full transition-all duration-500" style="width: 0%;"></div>
                </div>
              </div>

              <!-- Tab Panels -->
              <div x-show="tab === 'behavior'" id="behaviorSummary" class="p-5 bg-gray-700 rounded-lg">
                <p>Awaiting session data...</p>
              </div>
              <div x-show="tab === 'ethics'" id="autonomyScore" class="p-5 bg-gray-700 rounded-lg">
                <p>Calculating...</p>
              </div>
              
              <div id="ghostMessage" class="p-4 bg-gray-900 border border-dashed border-red-500 rounded-lg">
                <h3 class="font-bold text-lg text-red-400">A Voice in the Machine:</h3>
                <p class="italic mt-1">Ghost's commentary appears in the main simulation console above.</p>
              </div>
            </div>

            <div class="mt-8 text-center">
              <button id="emailReportBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                Generate Follow-up Email
              </button>
              <button id="downloadLogBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg ml-4 transition-transform transform hover:scale-105">
                Download Session Log (JSON)
              </button>
              <button id="replayBtn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg ml-4 transition-transform transform hover:scale-105">
                Replay Simulation
              </button>
            </div>
          </section>
        </main>

        <footer role="contentinfo" class="text-center mt-16 text-gray-500 text-sm">
          <p>This was a simulation. These were not real choices.</p>
          <p class="mt-1">Lotus + Autonomy Theater Capstone Project</p>
        </footer>
      </div>
    </div>
  </div>

  <!-- UI INTERFACE (HTML Partials) -->
  <div id="ui-interface" class="ui-interface fade-transition">
    <!-- Predatory UI Include -->
    <section id="predatory-ui" class="predatory-interface">
      <!-- Copilot: include predatory/hero.html here -->
      <div id="predatory-hero-container"></div>
      
      <!-- Copilot: include predatory/slider.html here -->
      <div id="predatory-slider-container"></div>
      
      <!-- Copilot: include predatory/form.html here -->
      <div id="predatory-form-container"></div>
      
      <!-- Copilot: include predatory/faq.html here -->
      <div id="predatory-faq-container"></div>
      
      <!-- Copilot: include predatory/trust-signals.html here -->
      <div id="predatory-trust-signals-container"></div>
      
      <!-- Copilot: include predatory/terms.html here -->
      <div id="predatory-terms-container"></div>
    </section>

    <!-- Ethical UI Include -->
    <section id="ethical-ui" class="ethical-interface" style="display:none;">
      <!-- Copilot: include ethical/hero.html here -->
      <div id="ethical-hero-container"></div>
      
      <!-- Copilot: include ethical/form-step1.html here -->
      <div id="ethical-form-step1-container"></div>
      
      <!-- Copilot: include ethical/form-step2.html here -->
      <div id="ethical-form-step2-container"></div>
      
      <!-- Copilot: include ethical/apr-display.html here -->
      <div id="ethical-apr-display-container"></div>
      
      <!-- Copilot: include ethical/education.html here -->
      <div id="ethical-education-container"></div>
      
      <!-- Copilot: include partials/ethical/alternatives.html here -->
      <div id="ethical-alternatives-container"></div>
      
      <!-- Copilot: include partials/ethical/calculator.html here -->
      <div id="ethical-calculator-container"></div>
      
      <!-- Copilot: include partials/ethical/footer.html here -->
      <div id="ethical-footer-container"></div>
    </section>
  </div>

  <!-- Loading indicator -->
  <div id="loading-indicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-9999" style="display: none;">
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <div class="flex items-center space-x-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
        <span>Loading interface...</span>
      </div>
    </div>
  </div>

  <!-- Include countdown script -->
  <script src="predatory/countdown.js" type="module"></script>
  
  <!-- Main application module -->
  <script type="module" src="app.js"></script>
  
  <!-- Interface integration script -->
  <script>
    // Copilot: Interface switching and partial loading system
    let currentInterface = 'simulation';
    let currentMode = 'predatory';
    let partialsLoaded = false;
    
    // Interface switching functionality
    async function switchInterface(interfaceType) {
      const loading = document.getElementById('loading-indicator');
      loading.style.display = 'flex';
      
      try {
        // Update active button states
        document.querySelectorAll('.interface-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(interfaceType === 'simulation' ? 'sim-interface-btn' : 'ui-interface-btn').classList.add('active');
        
        const simInterface = document.getElementById('simulation-interface');
        const uiInterface = document.getElementById('ui-interface');
        
        if (interfaceType === 'simulation') {
          // Switch to simulation interface
          uiInterface.classList.add('fade-out');
          await new Promise(resolve => setTimeout(resolve, 500));
          uiInterface.style.display = 'none';
          uiInterface.classList.remove('fade-out');
          
          simInterface.style.display = 'block';
          simInterface.classList.add('fade-in');
          
          currentInterface = 'simulation';
        } else {
          // Switch to UI interface and load partials if needed
          if (!partialsLoaded) {
            await loadAllPartials();
            partialsLoaded = true;
          }
          
          simInterface.classList.add('fade-out');
          await new Promise(resolve => setTimeout(resolve, 500));
          simInterface.style.display = 'none';
          simInterface.classList.remove('fade-out');
          
          uiInterface.style.display = 'block';
          uiInterface.classList.add('fade-in');
          
          currentInterface = 'ui';
          
          // Apply current mode to UI interface
          applyModeToUI(currentMode);
        }
        
        // Track interface switch
        if (window.LotusApp) {
          window.LotusApp.analytics.interactions++;
        }
        
      } catch (error) {
        console.error('Error switching interface:', error);
      } finally {
        loading.style.display = 'none';
      }
    }
    
    // Mode switching functionality
    function switchMode(mode) {
      // Update active button states
      document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(mode === 'predatory' ? 'predatory-btn' : 'ethical-btn').classList.add('active');
      
      currentMode = mode;
      
      // Apply mode to current interface
      if (currentInterface === 'ui') {
        applyModeToUI(mode);
      } else {
        // For simulation interface, update stylesheets
        const predStyles = document.getElementById('pred-styles');
        const ethStyles = document.getElementById('eth-styles');
        
        if (mode === 'predatory') {
          predStyles.disabled = false;
          ethStyles.disabled = true;
        } else {
          predStyles.disabled = true;
          ethStyles.disabled = false;
        }
      }
      
      // Track mode switch
      if (window.LotusApp) {
        window.LotusApp.currentMode = mode;
        window.LotusApp.analytics.interactions++;
      }
    }
    
    // Apply mode to UI interface
    function applyModeToUI(mode) {
      const predatoryUI = document.getElementById('predatory-ui');
      const ethicalUI = document.getElementById('ethical-ui');
      const predStyles = document.getElementById('pred-styles');
      const ethStyles = document.getElementById('eth-styles');
      
      if (mode === 'predatory') {
        predatoryUI.style.display = 'block';
        ethicalUI.style.display = 'none';
        predStyles.disabled = false;
        ethStyles.disabled = true;
      } else {
        predatoryUI.style.display = 'none';
        ethicalUI.style.display = 'block';
        predStyles.disabled = true;
        ethStyles.disabled = false;
      }
    }
    
    // Load all HTML partials dynamically
    async function loadAllPartials() {
      const partials = [
        // Predatory partials
        { container: 'predatory-hero-container', file: 'predatory/hero.html' },
        { container: 'predatory-slider-container', file: 'predatory/slider.html' },
        { container: 'predatory-form-container', file: 'predatory/form.html' },
        { container: 'predatory-faq-container', file: 'predatory/faq.html' },
        { container: 'predatory-trust-signals-container', file: 'predatory/trust-signals.html' },
        { container: 'predatory-terms-container', file: 'predatory/terms.html' },
        
        // Ethical partials
        { container: 'ethical-hero-container', file: 'ethical/hero.html' },
        { container: 'ethical-form-step1-container', file: 'ethical/form-step1.html' },
        { container: 'ethical-form-step2-container', file: 'ethical/form-step2.html' },
        { container: 'ethical-apr-display-container', file: 'ethical/apr-display.html' },
        { container: 'ethical-education-container', file: 'ethical/education.html' },
        { container: 'ethical-alternatives-container', file: 'partials/ethical/alternatives.html' },
        { container: 'ethical-calculator-container', file: 'partials/ethical/calculator.html' },
        { container: 'ethical-footer-container', file: 'partials/ethical/footer.html' }
      ];
      
      // Load all partials in parallel
      const loadPromises = partials.map(async ({ container, file }) => {
        try {
          const response = await fetch(file);
          if (response.ok) {
            const html = await response.text();
            const containerElement = document.getElementById(container);
            if (containerElement) {
              containerElement.innerHTML = html;
              
              // Execute any inline scripts in the loaded HTML
              const scripts = containerElement.querySelectorAll('script');
              scripts.forEach(script => {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.head.appendChild(newScript);
              });
            }
          } else {
            console.warn(`Failed to load partial: ${file}`);
          }
        } catch (error) {
          console.error(`Error loading partial ${file}:`, error);
        }
      });
      
      await Promise.all(loadPromises);
    }
    
    // Initialize interface
    document.addEventListener('DOMContentLoaded', function() {
      // Set initial interface and mode
      switchInterface('simulation');
      switchMode('predatory');
      
      // Initialize global app state
      if (!window.LotusApp) {
        window.LotusApp = {
          currentMode: 'predatory',
          currentInterface: 'simulation',
          analytics: {
            sessionStart: Date.now(),
            pageViews: 1,
            interactions: 0,
            conversions: 0
          },
          user: {
            visitCount: parseInt(localStorage.getItem('lotus_visits') || '0') + 1,
            timeOnSite: 0,
            highIntentSignals: []
          },
          config: {
            enableTracking: true,
            enablePressure: true,
            enableManipulation: true,
            debugMode: false
          }
        };
        
        localStorage.setItem('lotus_visits', window.LotusApp.user.visitCount.toString());
      }
    });
    
    // Auto-load UI interface after 2 seconds for demonstration
    setTimeout(() => {
      if (currentInterface === 'simulation') {
        // Show a subtle hint about the UI interface
        const simBtn = document.getElementById('ui-interface-btn');
        simBtn.style.animation = 'pulse 2s infinite';
        setTimeout(() => {
          simBtn.style.animation = '';
        }, 6000);
      }
    }, 2000);
  </script>
</body>
</html>
