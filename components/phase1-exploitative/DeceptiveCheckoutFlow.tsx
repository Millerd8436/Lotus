"use client";

import React, { useState } from "react";
import { Card } from "@/components/shared/Card";
import {
  InitialCaptureStep,
  PersonalInfoStep,
  EmploymentStep,
  IncomeVerificationStep,
  ReferencesStep,
  EmergencyContactsStep,
  DataHarvestStep,
  UrgencyHookStep,
  TipPressureStep,
  AddOnsStep,
  TermsTrapStep,
  FinalAuthorizationStep,
  SubmitStep,
} from ".";
import { DeceptiveInterstitial } from "./DeceptiveInterstitial";
import { PostPurchasePopUp } from "./PostPurchasePopUp";

interface DeceptiveCheckoutFlowProps {
  phase?: "exploitative" | "teaching";
  onPatternDetected: (pattern: string, severity: number) => void;
  onFinished: () => void;
}

export const DeceptiveCheckoutFlow: React.FC<DeceptiveCheckoutFlowProps> = ({
  phase = "exploitative",
  onPatternDetected,
  onFinished,
}) => {
  const [currentStep, setCurrentStep] = useState(0);
  const [showInterstitial, setShowInterstitial] = useState(true);
  const [showPostPurchasePopUp, setShowPostPurchasePopUp] = useState(false);

  const handleNext = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep((prev) => prev + 1);
    } else {
      setShowPostPurchasePopUp(true);
    }
  };

  const handleCancel = () => {
    console.log("Checkout canceled");
  };

  const handleInterstitialAcknowledge = () => {
    setShowInterstitial(false);
  };
  
  const handlePostPurchaseClose = () => {
    setShowPostPurchasePopUp(false);
    onFinished();
  }

  const steps = [
    <InitialCaptureStep key="initial" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <PersonalInfoStep key="personal" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <EmploymentStep key="employment" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <IncomeVerificationStep key="income" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <ReferencesStep key="references" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <EmergencyContactsStep key="contacts" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <DataHarvestStep key="data" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <UrgencyHookStep key="urgency" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <TipPressureStep key="tip" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <AddOnsStep key="addons" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <TermsTrapStep key="terms" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <FinalAuthorizationStep key="final" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
    <SubmitStep key="submit" onNext={handleNext} onCancel={handleCancel} phase={phase === "teaching" ? 3 : 1} onPatternDetected={onPatternDetected} />,
  ];

  if (showInterstitial) {
    return <DeceptiveInterstitial onAcknowledge={handleInterstitialAcknowledge} onPatternDetected={onPatternDetected} />;
  }
  
  if (showPostPurchasePopUp) {
    return <PostPurchasePopUp onClose={handlePostPurchaseClose} onPatternDetected={onPatternDetected} />;
  }

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <Card className="max-w-2xl mx-auto">
        {steps[currentStep]}
      </Card>
      <p className="text-xs text-center text-gray-400 mt-4">This is a simulation. Your data is not being stored.</p>
    </div>
  );
};

export default DeceptiveCheckoutFlow;
