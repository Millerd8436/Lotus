<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Copilot: Modular component-based architecture for development -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotus Modular - Component Architecture</title>
    
    <!-- Base Styles -->
    <link rel="stylesheet" href="assets/global.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- Development Styles -->
    <style>
        .module-container {
            border: 1px dashed #ccc;
            margin: 10px;
            padding: 15px;
            position: relative;
            background: #fafafa;
        }
        
        .module-label {
            position: absolute;
            top: -10px;
            left: 10px;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .module-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        
        .module-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .reload-btn { background: #28a745; color: white; }
        .edit-btn { background: #ffc107; color: black; }
        .remove-btn { background: #dc3545; color: white; }
        
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .dev-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: monospace;
            font-size: 14px;
            z-index: 1000;
        }
        
        .dev-controls button {
            background: #555;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .dev-controls button:hover {
            background: #777;
        }
        
        .module-library {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 250px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 80vh;
            overflow-y: auto;
            z-index: 999;
            display: none;
        }
        
        .library-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }
        
        .library-section {
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .library-item {
            padding: 8px 0;
            cursor: pointer;
            border-radius: 4px;
            padding-left: 10px;
            transition: background 0.2s;
        }
        
        .library-item:hover {
            background: #f8f9fa;
        }
        
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .error-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Development Toolbar -->
    <div class="dev-toolbar">
        <div class="dev-info">
            <span>üîß Modular Development Mode</span>
            <span id="module-count">Modules: 0</span>
            <span id="performance-info">Load Time: --ms</span>
        </div>
        <div class="dev-controls">
            <button onclick="toggleLibrary()">üìö Library</button>
            <button onclick="addModule()">‚ûï Add</button>
            <button onclick="saveLayout()">üíæ Save</button>
            <button onclick="loadLayout()">üìÇ Load</button>
            <button onclick="exportCode()">üì§ Export</button>
            <button onclick="togglePreview()">üëÅÔ∏è Preview</button>
        </div>
    </div>
    
    <!-- Module Library -->
    <div id="module-library" class="module-library">
        <div class="library-header">
            <span>Component Library</span>
            <button onclick="toggleLibrary()" style="float: right; background: none; border: none; font-size: 18px;">√ó</button>
        </div>
        
        <div class="library-section">
            <h4>Hero Components</h4>
            <div class="library-item" onclick="loadModule('hero', 'predatory')">Predatory Hero</div>
            <div class="library-item" onclick="loadModule('hero', 'ethical')">Ethical Hero</div>
        </div>
        
        <div class="library-section">
            <h4>Form Components</h4>
            <div class="library-item" onclick="loadModule('form', 'predatory')">Predatory Form</div>
            <div class="library-item" onclick="loadModule('form', 'application')">Loan Application</div>
            <div class="library-item" onclick="loadModule('calculator', 'apr')">APR Calculator</div>
            <div class="library-item" onclick="loadModule('calculator', 'ethical')">Ethical Calculator</div>
        </div>
        
        <div class="library-section">
            <h4>UI Components</h4>
            <div class="library-item" onclick="loadModule('slider', 'amount')">Amount Slider</div>
            <div class="library-item" onclick="loadModule('timer', 'countdown')">Countdown Timer</div>
            <div class="library-item" onclick="loadModule('faq', 'predatory')">Predatory FAQ</div>
            <div class="library-item" onclick="loadModule('alternatives', 'ethical')">Ethical Alternatives</div>
        </div>
        
        <div class="library-section">
            <h4>Engine Components</h4>
            <div class="library-item" onclick="loadModule('engine', 'urgency')">Urgency Engine</div>
            <div class="library-item" onclick="loadModule('engine', 'trap')">Trap UI Engine</div>
            <div class="library-item" onclick="loadModule('engine', 'behavioral')">Behavioral Engine</div>
            <div class="library-item" onclick="loadModule('engine', 'autonomy')">Autonomy Theater</div>
        </div>
        
        <div class="library-section">
            <h4>Analytics</h4>
            <div class="library-item" onclick="loadModule('analytics', 'research')">Research Analytics</div>
            <div class="library-item" onclick="loadModule('analytics', 'interaction')">Interaction Tracking</div>
        </div>
    </div>
    
    <!-- Error Overlay -->
    <div id="error-overlay" class="error-overlay">
        <div class="error-content">
            <h3>Module Load Error</h3>
            <p id="error-message">Something went wrong loading the module.</p>
            <button onclick="hideError()">Close</button>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div id="canvas" class="canvas">
        <div class="module-container" id="header-module">
            <div class="module-label">header</div>
            <div class="module-controls">
                <button class="module-btn reload-btn" onclick="reloadModule('header-module')">‚Üª</button>
                <button class="module-btn edit-btn" onclick="editModule('header-module')">‚úé</button>
                <button class="module-btn remove-btn" onclick="removeModule('header-module')">√ó</button>
            </div>
            
            <header style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>ü™∑ Lotus Modular Development</h1>
                    <div>
                        <button class="mode-btn" data-mode="predatory">Predatory Mode</button>
                        <button class="mode-btn" data-mode="ethical">Ethical Mode</button>
                        <button class="mode-btn" data-mode="compare">Compare Mode</button>
                    </div>
                </div>
            </header>
        </div>
    </div>
    
    <!-- Module Templates (Hidden) -->
    <template id="module-template">
        <div class="module-container">
            <div class="module-label"></div>
            <div class="module-controls">
                <button class="module-btn reload-btn" onclick="reloadModule(this.closest('.module-container').id)">‚Üª</button>
                <button class="module-btn edit-btn" onclick="editModule(this.closest('.module-container').id)">‚úé</button>
                <button class="module-btn remove-btn" onclick="removeModule(this.closest('.module-container').id)">√ó</button>
            </div>
            <div class="module-content"></div>
        </div>
    </template>
    
    <!-- Core Scripts -->
    <script src="assets/global.js"></script>
    <script src="core/loan_core.js"></script>
    
    <!-- Modular Development System -->
    <script>
        class ModularSystem {
            constructor() {
                this.modules = new Map();
                this.moduleCount = 0;
                this.canvas = document.getElementById('canvas');
                this.library = document.getElementById('module-library');
                this.performance = { start: performance.now() };
                
                this.init();
            }
            
            init() {
                // Track performance
                window.addEventListener('load', () => {
                    const loadTime = performance.now() - this.performance.start;
                    document.getElementById('performance-info').textContent = `Load Time: ${loadTime.toFixed(2)}ms`;
                });
                
                // Initialize with header module
                this.modules.set('header-module', {
                    type: 'header',
                    variant: 'default',
                    loaded: true
                });
                
                this.updateModuleCount();
                
                console.log('üîß Modular system initialized');
            }
            
            async loadModule(type, variant, containerId = null) {
                const moduleId = containerId || `module-${++this.moduleCount}`;
                
                try {
                    const content = await this.fetchModuleContent(type, variant);
                    const moduleElement = this.createModuleElement(moduleId, type, content);
                    
                    if (containerId) {
                        // Replace existing module
                        const existing = document.getElementById(containerId);
                        if (existing) {
                            existing.replaceWith(moduleElement);
                        }
                    } else {
                        // Add new module
                        this.canvas.appendChild(moduleElement);
                    }
                    
                    this.modules.set(moduleId, {
                        type,
                        variant,
                        loaded: true,
                        element: moduleElement
                    });
                    
                    this.updateModuleCount();
                    
                    // Execute any scripts in the loaded content
                    this.executeModuleScripts(moduleElement);
                    
                } catch (error) {
                    this.showError(`Failed to load ${type}/${variant}: ${error.message}`);
                }
            }
            
            async fetchModuleContent(type, variant) {
                let path = '';
                
                switch (type) {
                    case 'hero':
                        path = variant === 'predatory' ? 'predatory/hero.html' : 'partials/ethical/hero.html';
                        break;
                    case 'form':
                        if (variant === 'predatory') path = 'predatory/form.html';
                        else if (variant === 'application') path = 'predatory/form.html';
                        break;
                    case 'calculator':
                        if (variant === 'ethical') path = 'partials/ethical/calculator.html';
                        else if (variant === 'apr') path = 'ui_components/aprCalculator.js';
                        break;
                    case 'slider':
                        path = 'predatory/slider.html';
                        break;
                    case 'timer':
                        path = 'predatory/countdown.js';
                        break;
                    case 'faq':
                        path = 'predatory/faq.html';
                        break;
                    case 'alternatives':
                        path = 'partials/ethical/alternatives.html';
                        break;
                    case 'engine':
                        switch (variant) {
                            case 'urgency': path = 'ui_components/urgencyEngine.js'; break;
                            case 'trap': path = 'ui_components/trapUIEngine.js'; break;
                            case 'behavioral': path = 'engine/behavioralPsychology.js'; break;
                            case 'autonomy': path = 'engine/autonomy_theater.js'; break;
                        }
                        break;
                    case 'analytics':
                        if (variant === 'research') path = 'research/research_analytics.js';
                        else if (variant === 'interaction') path = 'research/researchDataCollector.js';
                        break;
                    default:
                        throw new Error(`Unknown module type: ${type}`);
                }
                
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                let content = await response.text();
                
                // If it's a JavaScript file, wrap in a script tag
                if (path.endsWith('.js')) {
                    content = '<div class="script-module">' +
                              '<h4>JavaScript Module: ' + type + '/' + variant + '</h4>' +
                              '<p>Script loaded from: <code>' + path + '</code></p>' +
                              '<div class="script-content">' + content + '</div>' +
                              '</div>';
                }
                
                return content;
            }
            
            createModuleElement(id, type, content) {
                const template = document.getElementById('module-template');
                const clone = template.content.cloneNode(true);
                
                const container = clone.querySelector('.module-container');
                container.id = id;
                
                const label = clone.querySelector('.module-label');
                label.textContent = type;
                
                const contentArea = clone.querySelector('.module-content');
                contentArea.innerHTML = content;
                
                return container;
            }
            
            executeModuleScripts(moduleElement) {
                const scripts = moduleElement.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.textContent = script.textContent;
                    document.head.appendChild(newScript);
                    // Remove it to avoid pollution
                    setTimeout(() => document.head.removeChild(newScript), 100);
                });
            }
            
            reloadModule(moduleId) {
                const moduleData = this.modules.get(moduleId);
                if (moduleData) {
                    this.loadModule(moduleData.type, moduleData.variant, moduleId);
                }
            }
            
            removeModule(moduleId) {
                const element = document.getElementById(moduleId);
                if (element && moduleId !== 'header-module') {
                    element.remove();
                    this.modules.delete(moduleId);
                    this.updateModuleCount();
                }
            }
            
            updateModuleCount() {
                document.getElementById('module-count').textContent = `Modules: ${this.modules.size}`;
            }
            
            showError(message) {
                document.getElementById('error-message').textContent = message;
                document.getElementById('error-overlay').style.display = 'flex';
            }
            
            exportLayout() {
                const layout = Array.from(this.modules.entries()).map(([id, data]) => ({
                    id,
                    type: data.type,
                    variant: data.variant
                }));
                
                return JSON.stringify(layout, null, 2);
            }
            
            async importLayout(layoutJson) {
                try {
                    const layout = JSON.parse(layoutJson);
                    
                    // Clear existing modules (except header)
                    this.modules.forEach((data, id) => {
                        if (id !== 'header-module') {
                            this.removeModule(id);
                        }
                    });
                    
                    // Load modules from layout
                    for (const module of layout) {
                        if (module.id !== 'header-module') {
                            await this.loadModule(module.type, module.variant);
                        }
                    }
                    
                } catch (error) {
                    this.showError(`Failed to import layout: ${error.message}`);
                }
            }
        }
        
        // Initialize modular system
        const modularSystem = new ModularSystem();
        
        // Global functions for UI
        window.toggleLibrary = () => {
            const library = document.getElementById('module-library');
            library.style.display = library.style.display === 'none' ? 'block' : 'none';
        };
        
        window.loadModule = (type, variant) => {
            modularSystem.loadModule(type, variant);
            toggleLibrary(); // Close library after selection
        };
        
        window.reloadModule = (moduleId) => {
            modularSystem.reloadModule(moduleId);
        };
        
        window.removeModule = (moduleId) => {
            modularSystem.removeModule(moduleId);
        };
        
        window.editModule = (moduleId) => {
            alert(`Edit functionality for ${moduleId} would open here`);
        };
        
        window.addModule = () => {
            toggleLibrary();
        };
        
        window.saveLayout = () => {
            const layout = modularSystem.exportLayout();
            const blob = new Blob([layout], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lotus-layout.json';
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.loadLayout = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        modularSystem.importLayout(e.target.result);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };
        
        window.exportCode = () => {
            alert('Code export functionality would generate production-ready code');
        };
        
        window.togglePreview = () => {
            // Toggle between development and preview mode
            document.body.classList.toggle('preview-mode');
        };
        
        window.hideError = () => {
            document.getElementById('error-overlay').style.display = 'none';
        };
        
        // Expose for debugging
        window.ModularSystem = modularSystem;
        
        console.log('üß© Modular development environment ready');
    </script>
</body>
</html>